var capturedPicture,shareImageButton=document.querySelector("#share-image-button"),createPostArea=document.querySelector("#create-post"),closeCreatePostModalButton=document.querySelector("#close-create-post-modal-btn"),sharedMomentsArea=document.querySelector("#shared-moments"),form=document.querySelector("form"),titleInput=document.querySelector("#title"),locationInput=document.querySelector("#location"),videoPlayer=document.querySelector("#player"),canvasElement=document.querySelector("#canvas"),captureButton=document.querySelector("#capture-btn"),imagePicker=document.querySelector("#image-picker"),imagePickerArea=document.querySelector("#pick-image"),locationBtn=document.querySelector("#location-btn"),locationLoader=document.querySelector("#location-loader"),fetchedLocation={lat:0,lng:0};function initializeLocation(){"geolocation"in navigator||(locationBtn.style.display="none")}function initializeMedia(){"mediaDevices"in navigator||(navigator.mediaDevices={}),"getUserMedia"in navigator.mediaDevices||(navigator.mediaDevices.getUserMedia=function(e){let t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return t?new Promise((function(o,a){t.call(navigator,e,o,a)})):Promise.reject(new Error("getUserMedia is not implemented!"))}),navigator.mediaDevices.getUserMedia({video:!0}).then((function(e){videoPlayer.srcObject=e,videoPlayer.style.display="block"})).catch((function(e){imagePickerArea.style.display="block"}))}function openCreatePostModal(){createPostArea.style.display="block",setTimeout((()=>{createPostArea.style.transform="translateY(0)"}),1),initializeMedia(),initializeLocation(),deferredPrompt&&(deferredPrompt.prompt(),deferredPrompt.userChoice.then((function(e){console.log(e.outcome),"dismissed"===e.outcome?console.log("User cancelled installation"):console.log("User added to home screen")})),deferredPrompt=null)}function closeCreatePostModal(){imagePickerArea.style.display="none",videoPlayer.style.display="none",canvasElement.style.display="none",locationBtn.style.display="inline",locationLoader.style.display="none",captureButton.style.display="inline",videoPlayer.srcObject&&videoPlayer.srcObject.getVideoTracks().forEach((function(e){e.stop()})),setTimeout((function(){createPostArea.style.transform="translateY(100vh)"}),1)}function onSaveButtonClicked(e){console.log("clicked"),"caches"in window&&caches.open("user-requested").then((function(e){e.add("https://httpbin.org/get"),e.add("/src/images/sf-boat.jpg")}))}function clearCards(){for(;sharedMomentsArea.hasChildNodes();)sharedMomentsArea.removeChild(sharedMomentsArea.lastChild)}function createCard(e){var t=document.createElement("div");t.className="shared-moment-card mdl-card mdl-shadow--2dp";var o=document.createElement("div");o.className="mdl-card__title",o.style.backgroundImage=`url('${e.image}')`,o.style.backgroundSize="cover",t.appendChild(o);var a=document.createElement("h2");a.style.color="white",a.className="mdl-card__title-text",a.textContent=e.title,o.appendChild(a);var n=document.createElement("div");n.className="mdl-card__supporting-text",n.textContent=e.location,n.style.textAlign="center",t.appendChild(n),componentHandler.upgradeElement(t),sharedMomentsArea.appendChild(t)}function updateUI(e){clearCards();for(let t of e)createCard(t)}locationBtn.addEventListener("click",(function(e){"geolocation"in navigator&&(locationBtn.style.display="none",locationLoader.style.display="block",navigator.geolocation.getCurrentPosition((function(e){locationBtn.style.display="inline",locationLoader.style.display="none",fetchedLocation={lat:e.coords.latitude,lng:0},locationInput.value="In Munich",document.querySelector("#manual-location").classList.add("is-focused")}),(function(e){console.log(e),locationBtn.style.display="inline",locationLoader.style.display="none",alert("Couldnt get your location, you can enter manually"),fetchedLocation={lat:0,lng:0}}),{timeout:7e3}))})),captureButton.addEventListener("click",(function(e){canvasElement.style.display="block",videoPlayer.style.display="none",captureButton.style.display="none";const t=canvasElement.getContext("2d"),o=videoPlayer.videoHeight/(videoPlayer.videoWidth/canvas.width);t.drawImage(videoPlayer,0,0,canvas.width,o),videoPlayer.srcObject.getVideoTracks().forEach((function(e){e.stop()})),capturedPicture=dataURItoBlob(canvasElement.toDataURL())})),imagePicker.addEventListener("change",(function(e){capturedPicture=e.target.files[0]})),shareImageButton.addEventListener("click",openCreatePostModal),closeCreatePostModalButton.addEventListener("click",closeCreatePostModal);let url="https://pdpgram.firebaseio.com/posts.json",isFetchedNetworkData=!1;function savePostData(e){let t=new FormData;t.append("id",e.id),t.append("title",e.title),t.append("location",e.location),t.append("file",e.picture,dt.id+".png"),t.append("rawLocationLat",e.rawLocation.lat),t.append("rawLocationLng",e.rawLocation.lng),fetch(url,{method:"POST",body:t}).then((function(e){console.log("Sent data",e),updateUI()}))}fetch(url).then((function(e){return e.json()})).then((function(e){isFetchedNetworkData=!0,console.log("From web",e);updateUI(Object.keys(e).reduce(((t,o)=>[...t,e[o]]),[]))})),"indexedDB"in window&&readFromIndexedDB("posts").then((e=>{isFetchedNetworkData||(console.log("From cache",e),updateUI(e))})),form.addEventListener("submit",(function(e){e.preventDefault();const t=titleInput.value,o=locationInput.value;if(""===t.trim()||""===o.trim())return void alert("Please fill title and location");closeCreatePostModal();let a={id:(new Date).toISOString(),title:t,location:o,picture:capturedPicture,rawLocation:fetchedLocation};"serviceWorker"in navigator&&"SyncManager"in window?navigator.serviceWorker.ready.then((function(e){writeToIndexedDB("sync-posts",a).then((function(){return e.sync.register("sync-new-posts")})).then((function(){document.querySelector("#confirmation-toast").MaterialSnackbar.showSnackbar({message:"Your post was saved for syncing!"})})).catch((function(e){console.log(e)}))})):savePostData(a)}));